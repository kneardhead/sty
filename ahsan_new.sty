\ProvidesPackage{ahsan_new}

% todo add a proper article class with sections rather than chapters
% todo recheck indexing in macro, because i can't call the macros without having to import
% indices

% TODO so far i can remember these classes
% Bangla  : has three subclasses
% Book    : For bigger projects, all features
% Article : For shorter files, quick compile, light
% Beamer  : Presnetations
% Hybrid  : A bit heavier than Article, but not as much as book
% And of course all the options should be flexible

% TODO add tikz support
% \usepackage{pgfplots} 
% \pgfplotsset{width=8cm,compat=1.9} 
% \usepgfplotslibrary{external} 
% % \tikzexternalize 

% TODO add variables to control fonts inside environments centrally
% TODO add more color variables for the lstlistings


\newif \ifahsan@memoir      
\@ifclassloaded{memoir}{\ahsan@memoirtrue}{\ahsan@memoirfalse}
\newif \ifahsan@article
\@ifclassloaded{article}{\ahsan@articletrue}{\ahsan@articlefalse}
\newif \ifahsan@beamer      
\@ifclassloaded{beamer}{\ahsan@beamertrue}{\ahsan@beamerfalse}

\newif \ifahsanbook \ahsanbookfalse
\DeclareOption{book}{\ahsanbooktrue}
\newif \ifahsan@bangla \ahsan@banglafalse
\DeclareOption{bangla}{\ahsan@banglatrue}
\newif \ifahsan@Fullbangla \ahsan@Fullbanglafalse
\DeclareOption{fullbangla}{\ahsan@banglatrue\ahsan@Fullbanglatrue}
\newif \ifahsanhybrid \ahsanhybridtrue
\DeclareOption{hybrid}{\ahsanhybridtrue}



\newif \ifahsanfont        \ahsanfonttrue
\newif \ifahsansans        \ahsansanstrue
\newif \ifahsanshare       \ahsansharefalse
\newif \ifahsanmathsans    \ahsanmathsansfalse

\newif \ifahsanfigs        \ahsanfigstrue
\newif \ifahsanfancyhdr    \ahsanfancyhdrfalse
\newif \ifahsanhref        \ahsanhreftrue

\newif \ifahsanauthor      \ahsanauthortrue
\newif \ifahsanindex       \ahsanindexfalse
\newif \ifahsantoc         \ahsantocfalse
\newif \ifahsanhint        \ahsanhintfalse
\newif \ifahsanaccessories \ahsanaccessoriesfalse

\newif \ifahsanthm         \ahsanthmtrue
\newif \ifahsansecthm      \ahsansecthmfalse
\newif \ifahsanfancythm    \ahsanfancythmtrue
\newif \ifahsanfancysoln   \ahsanfancysolnfalse
\newif \ifahsanimpprob     \ahsanimpprobfalse
\newif \ifahsansoul        \ahsansoulfalse
\newif \ifahsannumdef      \ahsannumdeffalse
\newif \ifahsanpagenotes   \ahsanpagenotesfalse


\DeclareOption {noauthor}   {\ahsanauthorfalse}
\DeclareOption {nofig}      {\ahsanfigsfalse}
\DeclareOption {nofont}     {\ahsanfontfalse}
\DeclareOption {sans}       {\ahsansanstrue}
\DeclareOption {serif}      {\ahsansansfalse}
\DeclareOption {share}      {\ahsansharetrue}
\DeclareOption {mathsans}   {\ahsanmathsanstrue}
\DeclareOption {acc}        {\ahsanaccessoriestrue}
\DeclareOption {impprob}    {\ahsanimpprobtrue}

\DeclareOption {thm}        {\ahsanthmtrue}
\DeclareOption {nothm}      {\ahsanthmfalse}
\DeclareOption {secthm}     {\ahsansecthmtrue}
\DeclareOption {nosecthm}   {\ahsansecthmfalse}
\DeclareOption {fancythm}   {\ahsanfancythmtrue}
\DeclareOption {nofancysoln}{\ahsanfancysolnfalse}
\DeclareOption {nofancythm} {\ahsanfancythmfalse \ahsanfancysolnfalse}

\DeclareOption {fancy}      {\ahsanfancyhdrtrue}
\DeclareOption {nofancy}    {\ahsanfancyhdrfalse}
\DeclareOption {toc}        {\ahsantoctrue}
\DeclareOption {hint}       {\ahsanhinttrue}
\DeclareOption {href}       {\ahsanhreftrue}
\DeclareOption {nohref}     {\ahsanhreffalse}
\DeclareOption {index}      {\ahsanindextrue}
\DeclareOption {noindex}    {\ahsanindexfalse}
\DeclareOption {soul}       {\ahsansoultrue}
\DeclareOption {numdef}     {\ahsannumdeftrue}
\DeclareOption {pagenotes}  {\ahsanpagenotestrue}



\newif \ifnotheme         \nothemetrue
\newif \ifdarkbluetheme   \darkbluethemefalse
\newif \ifdarkpinktheme   \darkpinkthemefalse
\newif \iflightgreentheme \lightgreenthemefalse
\newif \iflightpinktheme  \lightpinkthemefalse
\newif \ifwhitegreentheme \whitegreenthemefalse
\newif \ificmcbtheme      \icmcbthemefalse
\newif \ifmonocolortheme  \monocolorthemefalse

\DeclareOption {darkblue}   {\nothemefalse\darkbluethemetrue}
\DeclareOption {darkpink}   {\nothemefalse\darkpinkthemetrue}
\DeclareOption {lightgreen} {\nothemefalse\lightgreenthemetrue}
\DeclareOption {lightpink} {\nothemefalse\lightpinkthemetrue}
\DeclareOption {whitegreen} {\nothemefalse\whitegreenthemetrue}
\DeclareOption {monocolor}  {\nothemefalse\monocolorthemetrue}
\DeclareOption {icmcb}      {\nothemefalse\icmcbthemetrue}

\ProcessOptions\relax

\ifahsanhybrid  
    \ahsanfancyhdrtrue                      
\fi
\ifahsan@article 
    \ahsanfancyhdrfalse 
    \ahsan@memoirfalse   
\fi
\ifahsan@beamer
    \ahsanhreffalse 
    \ahsanfontfalse
    \ahsanaccessoriestrue 
    \ahsanthmfalse  
    \ahsan@memoirfalse
    \ahsanfancythmfalse   
\fi
\ifahsanbook
    \ahsansecthmtrue 
    \ahsanfancyhdrtrue
    \ahsanindextrue  
    \ahsanaccessoriestrue 
    \ahsantoctrue
\fi


\usepackage{amsmath} 
\usepackage{amssymb, nicefrac}
\usepackage{macros}

\setlength\parindent{0pt}
\setlength\parskip{10pt}

\ifdarkbluetheme   \usepackage[darkBlue]{mycolors}   \fi
\ifdarkpinktheme   \usepackage[darkPink]{mycolors}   \fi
\iflightgreentheme \usepackage[lightGreen]{mycolors} \fi
\iflightgreentheme \usepackage[lightPink]{mycolors} \fi
\ifwhitegreentheme \usepackage[whiteGreen]{mycolors} \fi
\ifmonocolortheme  \usepackage[monocolor]{mycolors}  \fi
\ificmcbtheme      \usepackage[icmcb]{mycolors}      \fi
\ifnotheme         \usepackage[plain]{mycolors}      \fi


\ifahsan@beamer
\else
\usepackage{titlesec}
\fi



\ifahsan@bangla
\else
    \ifahsan@memoir
        %%%%% Display Style %%%%%%%%%%
        % \titleformat{\chapter}[display]
        % {\normalfont}
        % {\filright\normalfont \LARGE Chapter \bfseries\Huge\thechapter}
        % {10pt}
        % {\filright\Huge\bfseries}[\thispagestyle{empty}\newpage]

        %%%%% Frame Style %%%%%%%%%%
        \titleformat{\chapter}[frame]
        {\normalfont}
        {\filright\small\enspace CHAPTER\enspace\bfseries \LARGE\thechapter\enspace}
        {10pt}
        {\Huge\bfseries\filcenter}[\thispagestyle{empty}\newpage]


        \titleformat{\section}
        {\color{titleC}\normalfont\Large\bfseries}
        {\S \thesection}
        {1em}
        {}

        \titleformat{\subsection}
        {\color{titleC}\normalfont\large\bfseries}
        {\thesubsection}
        {1em}
        {}

        % \newcommand{\sectionbreak}{\clearpage}

        \titlespacing*{\chapter}{0pt}{2em plus 1em minus .2em}{10em plus 2em}
        \titlespacing*{\section}{0pt}{2em plus 1em minus .2em}{2em plus .2em}
        \titlespacing*{\subsection}{0pt}{1em plus .5em minus .2em}{1em plus .2em}

        \setlrmarginsandblock{8em}{6em}{*}
        \setulmarginsandblock{8em}{8em}{*}
        \checkandfixthelayout
    \fi
    \ifahsan@article
        \titleformat{\section}
        {\color{thmC}\normalfont\Large\bfseries}
        {\S \thesection}
        {.5em}
        {}

        \titleformat{\subsection}
        {\color{thmC!90!defC}\normalfont\large\bfseries}
        {\thesubsection}
        {.5em}
        {}

        \titlespacing*{\section}{0pt}{6ex plus 1ex minus 1ex}{3ex plus .2ex}
        \titlespacing*{\subsection}{0pt}{4ex plus 1ex minus 1ex}{1ex plus .2ex}

        \usepackage[a4paper, margin=1in]{geometry}
    \fi
\fi



% todo write new latexbangla
\ifahsan@bangla
    \usepackage{polyglossia}
    \setmainlanguage[numerals=Bengali]{bengali}
    \setotherlanguage{english}
    \RequirePackage[Latin, Bengali, Devanagari]{ucharclasses}
\else   
    \ifahsan@beamer
    \else
        \usepackage[inline]{enumitem}
        \setlist[enumerate]{topsep=0pt, itemsep=0pt}
        \setlist[itemize]{topsep=0pt, itemsep=0pt}
    \fi
\fi


\ifahsanfont
    \usepackage{fontspec}
    \usepackage[T1]{fontenc}
    \ifahsan@bangla
        \newfontfamily\bengalifont[
        Script=Bengali,
        Scale=MatchLowercase,
        WordSpace=1.1,
        AutoFakeSlant,
        AutoFakeBold=2.5
        ]{Kalpurush}

        \newfontfamily\bengalifontsf[
        Script=Bengali,
        Scale=MatchLowercase,
        WordSpace=1.1,
        AutoFakeSlant,
        AutoFakeBold=2.5
        ]{Kalpurush}
        
        \newfontfamily\bengalifonttt[
        Script=Bengali,
        Scale=0.8,
        WordSpace=1.2,
        AutoFakeSlant,
        AutoFakeBold
        ]{Siyam Rupali}

        \newfontfamily\englishfontsf[
        Scale=MatchUppercase
        ]{CMU Sans Serif}

        \newfontfamily\englishfonttt[
        Scale=MatchUppercase
        ]{Share Tech Mono}

        \newfontfamily\englishfontrm[
        Scale=MatchUppercase
        ]{CMU Serif}

        \ifahsansans
            \newcommand\englishfont\englishfontsf
        \else
            \newcommand\englishfont\englishfontrm
        \fi

        \newenvironment{latintt}{
            \fontencoding{OT1}\englishfonttt\selectfont
        }\relax
        \setTransitionsFor{Bengali}{\begingroup\bengalifontsf}{\endgroup}
        % \newenvironment{latin}{\fontencoding{OT1}\englishfont\selectfont}\relax
        % \setTransitionsForLatin{\begin{latin}}{\end{latin}}

        % \newenvironment{latin}{\fontencoding{OT1}\ifx\f@family\ttfamily
        % \englishfonttt\else\englishfont\fi\selectfont}\relax
        % \setTransitionsForLatin{\begin{latin}}{\end{latin}}

        \newcommand{\Share}{\rmfamily}
        \newcommand{\Titillium}{\sffamily}
    \else
        \setmonofont{Share Tech Mono} [Scale=MatchUppercase, Scale=.9]
        \newfontfamily\Share[Ligatures=TeX, Scale=MatchUppercase, WordSpace=.9]{Share}
        \newfontfamily\Titillium[Ligatures=TeX, Scale=.9]{Titillium Web}

        \ifahsanmathsans \usepackage{sansmathfonts} \else \usepackage{mathptmx} \fi

        \ifahsansans
            \renewcommand{\familydefault}{\sfdefault} \fontfamily{cmss}
        \else
            \fontfamily{cmr}
        \fi

        \ifahsanshare
            \setsansfont{Share}[Scale=MatchUppercase]
            % \newfontfamily\Titillium[Ligatures=TeX, Scale=MatchUppercase, WordSpacce=.9]{Share}
        \fi

    \fi    
\else
    \usepackage[T1]{fontenc}
    \usepackage[scaled=0.9]{inconsolata}
    \ifahsansans
        \renewcommand{\familydefault}{\sfdefault} \fontfamily{cmss}
    \fi
    \newcommand{\Share}{\rmfamily}
    \newcommand{\Titillium}{\sffamily}
\fi


\ifahsansoul
    \let\ul\undefined
    \let\st\undefined
    \usepackage{soul}

    \setul{0.2ex}{0.1ex}
    \colorlet{ulC}{fgC!70!white}
    \setulcolor{ulC}
\fi





\ifahsanfancyhdr
    \usepackage{fancyhdr, setspace}

    % \makepagestyle{plain}
    % % \makeevenhead{plain}{\rightmark\leftmark}{}{}
    % \makeoddhead{plain}
    % {\fontsize{10}{12} \selectfont \thepage}
    % {}
    % {\fontsize{10}{12} \selectfont \leftmark}

    % \makeevenhead{plain}
    % {\fontsize{10}{12} \selectfont \rightmark}
    % {}
    % {\fontsize{10}{12} \selectfont \thepage}

    % \renewcommand*{\sectionmark}[1]{\markboth{#1}{}}
    % \renewcommand*{\subsectionmark}[1]{\markright{#1}}
    % \pagestyle{plain}
\fi


% theorem options
\ifahsanthm
    \ifahsanfancythm
        \ifahsansecthm
            \ifahsanfancysoln
                \usepackage[secthm, fancythm]{tcbs}
            \else
                \usepackage[secthm, nofancysoln, fancythm]{tcbs}
            \fi
        \else
            \ifahsanfancysoln
                \usepackage[fancythm]{tcbs}
            \else
                \usepackage[fancythm, nofancysoln]{tcbs}
            \fi
        \fi
        \else
        \usepackage{tcbs}
    \fi
\else
    \usepackage[nothm]{tcbs}
\fi



% Show/Hide figures
\ifahsanfigs 
    \usepackage{graphicx} 
    \usepackage{import}
    \usepackage{xifthen}
    \usepackage{pdfpages}
    \usepackage{transparent}

    \newcommand{\incfig}[2][1]{%
        \fontsize{8}{9}\selectfont
        \def\svgwidth{#1\columnwidth}
        \import{./figs/}{#2.pdf_tex}
        \fontsize{8}{11}\selectfont
    }
    
\else 
    \usepackage[draft]{graphicx} 
\fi


\ifahsanaccessories
    \usepackage{float, multicol, subfig, pgf, tikz, pgfplots}
    \pgfplotsset{compat=1.17}
\fi


% table of content specs
\ifahsantoc
    \usepackage[usehighlevels]{alnumsec}
    \ifahsan@memoir
        \usepackage{tocloft}
        \setcounter{tocdepth}{4}
        \setcounter{secnumdepth}{4}
        \alnumsectionlevels{1}{chapter, section, subsection, subsubsection, paragraph}
    \else
        \ifahsan@article
            \usepackage[subfigure]{tocloft}
            \setcounter{tocdepth}{3}
            \setcounter{secnumdepth}{3}
            \alnumsectionlevels{1}{section, subsection, subsubsection, paragraph}
            \renewcommand\cftsecafterpnum{\vskip8pt}
            \renewcommand\cftsubsecafterpnum{\vskip0pt}
        \fi
    \fi
    \alnumsecstyle{aaaa}
    \surroundarabic[{.}][]{}{}
    \otherseparators{1}
    \alnumsecstyle{aaaa}
\fi

\ifahsanhint
    \usepackage{answers}
    \Newassociation{hinted}{Hint}{hints}
    \AtBeginDocument{\Opensolutionfile{hints}[hints]}
    \AtEndDocument{
        \Closesolutionfile{hints}
        \newpage
        \renewenvironment{Hint}[1]{\begin{hint}{\textbf{#1 }}}{\end{hint}}
        \section{Hints}
        \input{hints}
    }
\fi


\ifahsanauthor 
    \author{M Ahsan Al Mahir} 
    \date{\today} 
\fi


% index making
\ifahsanindex
    \usepackage{imakeidx}

    \indexsetup{level=\section*, toclevel=section, headers={\indexname}{}}

    \makeindex[name=def,   title=Definitions, options= {-s indStyle.ist}]
    \makeindex[name=prob,  title=Problems,    options= {-s indStyle.ist}]
    \makeindex[name=thm,   title=Theorems,    options= {-s indstyle.ist}]
    \makeindex[name=strat, title=Strategies,  options= {-s indstyle.ist}]
    \makeindex[            title=Misc,        options= {-s indStyle.ist}]
    % \makeindex[name=cat, title=Categories, options= -s indStyle.ist]
\fi


\ifahsanhref
    \usepackage{hyperref}
    % \def\Hy@colorlink#1{\begingroup\fontshape{it}\selectfont}%
    \hypersetup{
        colorlinks=true,
        linkcolor=linkC,
        filecolor=fileC,      
        urlcolor=urlC,
        citecolor = defC,
    }
\fi


\ifahsan@beamer
    \usepackage[english]{babel}
    \usepackage{metalogo}
    \usepackage{fontspec}

    \setsansfont{Andika New Basic}
    \setmainfont{Yanone Kaffeesatz}
    \setmonofont{Share Tech Mono}
    % \setsansfont{CMU Sans Serif}  [Scale=MatchUppercase]
    % \setmonofont{Share Tech Mono} [Scale=MatchLowercase]
    % \setmainfont{CMU Serif}       [Scale=MatchLowercase]

    \ifdarkbluetheme 
        \usetheme{NordDark} 
    \else
        \usetheme{NordWhite} 
    \fi

    \AtBeginSection[]{ 
        \begin{frame}[c,noframenumbering,plain]
            \tableofcontents[sectionstyle=show/hide,subsectionstyle=show/show/hide]
        \end{frame} 
    }

    \AtBeginSubsection[]{ 
        \begin{frame}[c, noframenumbering,plain]
            \tableofcontents[sectionstyle=show/hide,subsectionstyle=show/shaded/hide]
        \end{frame} 
    }

    % \ahsansetupfalse
\fi

\ifahsanindex
    \def\Chaptername{No Chpater}
    \def\Sectionname{No Section}
    \def\Subsectionname{No Subsection}
    \let\Chaptermark\chaptermark
    \def\chaptermark#1{\def\Chaptername{#1}\Chaptermark{#1}}
    \let\Sectionmark\sectionmark
    \def\sectionmark#1{\def\Sectionname{#1}\Sectionmark{#1}}
    \let\Subsectionmark\subsectionmark
    \def\subsectionmark#1{\def\Subsectionname{#1}\Subsectionmark{#1}}
    \let\Subsubsectionmark\subsubsectionmark
    \def\subsubsectionmark#1{\def\Subsubsectionname{#1}\Subsubsectionmark{#1}}
\fi

\ifahsanpagenotes
    \usepackage{pagenote}
    \renewcommand*{\notedivision}{\subsection*{\notesname\ to Section~\thesection}}
    \renewcommand*{\pagenotesubhead}[2]{}
    \makepagenote
\fi

\hypersetup{
    colorlinks = true,
    linkcolor  = linkC,
    filecolor  = fileC,
    urlcolor   = urlC,
}

\DeclareRobustCommand{\signature}{A%
    \kern-.09em {\setbox0\hbox{T}%
        \vbox to\ht0{\hbox{%
            \csname S@\f@size\endcsname\fontsize\sf@size\z@ \math@fontsfalse\selectfont {H\hspace{.55mm}} }%
        \vss}%
}\kern-.40em \hbox{S\kern-.1667em\lower.5ex\hbox{A\hspace{-.5mm}}\kern-.125ex{N}}}

%todo: page number on title pages


%%% Footnote specs
\usepackage[hang,flushmargin]{footmisc}
\setlength{\footnotesep}{.8\baselineskip}
